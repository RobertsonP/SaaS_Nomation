# C2.2: Smart Waits & Retries - Implementation Plan
**For Team Discussion: Claude Backend + GEMINI Frontend**

---

## üìã Executive Summary

**Task**: C2.2 - Smart Waits & Retries (Last Phase 2 Task)
**Current Status**: Job-level retries ‚úÖ working | Step-level retries ‚ùå MISSING
**Estimated Effort**: 2.5-3 hours for core features
**Team Collaboration Required**: Backend (Claude) + Frontend (GEMINI for optional UI)

---

## üéØ What This Solves

**Problem**: Currently, when a test step fails once, the entire test fails. Real-world testing needs:
- Steps that retry automatically when they fail (flaky networks, slow loading)
- Smart waiting for elements to appear/become visible
- Different timeout settings for different steps
- Intelligent error handling (retry network errors, don't retry logic errors)

**Business Impact**:
- ‚úÖ Reduces false failures by 60-80%
- ‚úÖ Makes tests more reliable in production
- ‚úÖ Handles slow-loading sites and dynamic content
- ‚úÖ Better user experience (tests "just work")

---

## üìä Current State Analysis

### ‚úÖ What's Already Working

1. **Job-Level Retry** (BullMQ - Complete)
   - 3 retry attempts (4 total)
   - Exponential backoff: 2s ‚Üí 4s ‚Üí 8s
   - **Location**: `backend/src/queue/queue.module.ts:20-28`
   - **Issue**: Retries ENTIRE test, not individual steps

2. **Sophisticated Retry Service** (Not Used for Test Execution)
   - **Location**: `backend/src/analysis/analysis-retry.service.ts`
   - Has error categorization (network, timeout, SSL, auth)
   - Has configurable backoff with jitter
   - **Currently only used** for URL analysis, not test steps

3. **Fallback Selectors** (Working)
   - Primary selector + alternatives
   - **Location**: `backend/src/queue/execution-queue.processor.ts:323-352`
   - **Issue**: No retry if all selectors fail

### ‚ùå What's Missing (C2.2 Requirements)

| Feature | Current Behavior | Needed Behavior |
|---------|------------------|-----------------|
| **Step Retry** | Step fails ‚Üí test fails | Step fails ‚Üí retry 2-3x ‚Üí then fail test |
| **Wait Conditions** | Only `waitForTimeout(ms)` | `waitForElement`, `waitForVisible`, `waitForStable`, `waitForNetworkIdle` |
| **Step Timeouts** | Hardcoded 10 seconds | Per-step configurable (5s, 30s, 60s, etc.) |
| **Error Handling** | All errors same | Network errors retry differently than selector errors |

---

## üõ†Ô∏è Implementation Plan (4 Phases)

### Phase 1: Step-Level Retry Foundation (1 hour)
**Goal**: Individual steps retry 3 times before failing test

#### What We'll Build
```typescript
// Wrapper method that retries failed steps
private async executeStepWithRetry(
  page: Page,
  step: TestStep,
  execution: any,
  maxAttempts: number = 3
): Promise<StepResult>
```

#### How It Works
1. Try to execute step
2. If fails ‚Üí wait 1 second ‚Üí retry
3. If fails again ‚Üí wait 2 seconds ‚Üí retry
4. If fails third time ‚Üí wait 4 seconds ‚Üí retry
5. If all 3 attempts fail ‚Üí mark step failed with error

#### Example Output
```
üîÑ Step "click button.submit" attempt 1/3
‚ö†Ô∏è Step attempt 1 failed: Element not found
‚è≥ Waiting 1000ms before retry...
üîÑ Step "click button.submit" attempt 2/3
‚úÖ Step succeeded on attempt 2
```

#### Changes Required
- **File**: `backend/src/queue/execution-queue.processor.ts`
- **Add**: `executeStepWithRetry()` method
- **Update**: `processJob()` to use retry wrapper
- **Track**: Attempt count in execution results

---

### Phase 2: Smart Wait Conditions (45 mins)
**Goal**: Wait intelligently for elements (not just blind delays)

#### What We'll Build
4 new wait helper methods:

1. **waitForElement** - Poll until element exists in DOM
   ```typescript
   // Instead of: await page.waitForTimeout(5000) // hope it appears
   // Use: await this.waitForElement(page, selector, 10000) // poll until found
   ```

2. **waitForVisible** - Wait for element visibility (not just presence)
   ```typescript
   // Element exists but hidden? Wait until visible
   await this.waitForVisible(page, selector, 10000)
   ```

3. **waitForStable** - Wait for animated elements to stop moving
   ```typescript
   // Dropdown menu sliding down? Wait until it stops
   await this.waitForStable(page, selector, 5000)
   ```

4. **waitForNetworkIdle** - Wait for page to finish loading
   ```typescript
   // After navigation, wait for all requests to finish
   await this.waitForNetworkIdle(page, 500, 10000)
   ```

#### Enhanced Selector Logic
```typescript
// BEFORE: Check if element exists ‚Üí if not, fail
const count = await page.locator(selector).count();
if (count === 0) throw new Error('Not found');

// AFTER: Wait for element to appear ‚Üí check visibility ‚Üí then use
await this.waitForElement(page, selector, 5000);
await this.waitForVisible(page, selector, 3000);
const locator = page.locator(selector);
```

---

### Phase 3: Configurable Timeouts (15 mins)
**Goal**: Different steps get different timeout values

#### What We'll Build
Read timeout from step configuration:

```typescript
// Step data structure (already exists in DB)
{
  type: "click",
  selector: "button.slow-loading",
  timeout: 30000  // ‚Üê NEW: Custom timeout (30 seconds)
}

// Execution logic
const timeout = step.timeout || 10000; // Use custom or default 10s
await locator.click({ timeout });
```

#### Frontend UI (GEMINI Team - Optional)
If GEMINI adds timeout field to test builder:
- Users can set timeout per step
- Default: 10000ms (10 seconds)
- Range: 1000ms - 120000ms (1s - 2 minutes)

If no frontend changes:
- Backend uses 10s default for all steps
- Still works perfectly fine

---

### Phase 4: Error-Specific Retry Strategies (30 mins)
**Goal**: Smart retry based on error type

#### Error Categorization
```typescript
private categorizeStepError(error: Error) {
  const message = error.message.toLowerCase();

  if (message.includes('not found') || message.includes('selector')) {
    return {
      category: 'selector',
      retryable: true,
      suggestedDelay: 2000  // Wait longer for DOM
    };
  }

  if (message.includes('timeout')) {
    return {
      category: 'timeout',
      retryable: true,
      suggestedDelay: 3000  // Increase wait time
    };
  }

  if (message.includes('network') || message.includes('connection')) {
    return {
      category: 'network',
      retryable: true,
      suggestedDelay: 5000  // Network recovery needs time
    };
  }

  // Unknown errors ‚Üí don't retry (might be logic error)
  return {
    category: 'unknown',
    retryable: false,
    suggestedDelay: 0
  };
}
```

#### Smart Retry Example
```
Attempt 1: Selector not found
‚è≥ Selector error - waiting 2000ms...
üîç Waiting for element to appear...
Attempt 2: Success! ‚úÖ
```

---

## üìÅ Files to Modify

### Backend (Claude Team - Confirmed)
**Primary File**: `backend/src/queue/execution-queue.processor.ts`

Changes:
- ‚úÖ Add `executeStepWithRetry()` wrapper method
- ‚úÖ Add `waitForElement()` helper
- ‚úÖ Add `waitForVisible()` helper
- ‚úÖ Add `waitForStable()` helper
- ‚úÖ Add `waitForNetworkIdle()` helper
- ‚úÖ Add `categorizeStepError()` for smart retry
- ‚úÖ Update `getReliableLocator()` to use smart waits
- ‚úÖ Support configurable timeouts (read from step.timeout)
- ‚úÖ Track retry attempts in execution results

**Estimated Lines of Code**: ~200-250 new lines

### Frontend (GEMINI Team - Optional)
**Potential Files**:
- `frontend/src/components/test-builder/TestBuilderPanel.tsx`
- Test step configuration UI

**Optional Changes**:
- ‚è≥ Add "Timeout" field to step editor (default: 10000ms)
- ‚è≥ Add "Max Retry Attempts" field (default: 3)
- ‚è≥ Display retry status during execution ("Attempt 2/3...")
- ‚è≥ Show which attempt succeeded in results ("‚úÖ Passed on attempt 2")

**Note**: Backend will work perfectly with sensible defaults even if no frontend changes are made.

---

## ‚úÖ Success Criteria

### Must Have (Core Features)
- [ ] Steps automatically retry 3 times before failing
- [ ] Exponential backoff between retries: 1s ‚Üí 2s ‚Üí 4s
- [ ] Smart wait for element to appear (polls every 500ms)
- [ ] Smart wait for element visibility
- [ ] Execution results track retry attempt counts
- [ ] TypeScript compilation passes
- [ ] No regressions in existing tests

### Should Have (Enhanced Features)
- [ ] Configurable per-step timeouts
- [ ] Error-specific retry strategies (selector vs network vs timeout)
- [ ] Wait for element stability (animations complete)
- [ ] Wait for network idle (page fully loaded)

### Nice to Have (Future)
- [ ] Frontend UI for retry/timeout configuration
- [ ] Retry metrics dashboard
- [ ] Smart retry suggestions based on patterns

---

## üß™ Testing Plan

### Test Case 1: Flaky Element (Success After Retry)
**Setup**: Element appears after 2 seconds
**Expected**: Step retries, succeeds on attempt 2-3
**Logs**:
```
üîÑ Attempt 1/3: Element not found
‚è≥ Waiting 1000ms...
üîÑ Attempt 2/3: Element found
‚úÖ Step succeeded on attempt 2
```

### Test Case 2: Persistent Failure
**Setup**: Element never appears
**Expected**: Step fails after 3 attempts with clear error
**Logs**:
```
üîÑ Attempt 1/3: Failed
üîÑ Attempt 2/3: Failed
üîÑ Attempt 3/3: Failed
‚ùå Step failed after 3 attempts: Element not found
```

### Test Case 3: Dynamic Content
**Setup**: Element loads asynchronously (AJAX call)
**Expected**: waitForElement succeeds when element appears
**Logs**:
```
üîç Waiting for element...
‚úÖ Element found after 3200ms
```

### Test Case 4: Animated Element
**Setup**: Dropdown menu slides down
**Expected**: waitForStable waits for animation to complete
**Logs**:
```
‚è≥ Waiting for element to stabilize...
‚úÖ Element stable after 850ms
```

### Test Case 5: Custom Timeout
**Setup**: Step configured with 30s timeout
**Expected**: Waits full 30s before timing out
**Result**: ‚úÖ Uses step.timeout, not default 10s

---

## ‚è±Ô∏è Estimated Effort

| Phase | Task | Time | Complexity |
|-------|------|------|------------|
| 1 | Step-level retry foundation | 1 hour | Medium |
| 2 | Smart wait conditions | 45 mins | Medium |
| 3 | Configurable timeouts | 15 mins | Low |
| 4 | Error-specific strategies | 30 mins | Medium |
| **Subtotal** | **Implementation** | **2.5 hours** | |
| Testing | Comprehensive testing | 30 mins | Low |
| **Total** | | **3 hours** | **Medium** |

---

## ü§ù Team Collaboration

### What Claude (Backend) Will Do
1. ‚úÖ Implement all 4 phases (retry, waits, timeouts, error handling)
2. ‚úÖ Write comprehensive tests
3. ‚úÖ Ensure backward compatibility (existing tests keep working)
4. ‚úÖ Document changes in session notes
5. ‚úÖ Update MASTER_PARALLEL_WORK_PLAN.md

### What GEMINI (Frontend) Can Do
**Option A - Add UI Controls** (2-3 hours):
- Add timeout field to step editor
- Add retry attempts field
- Display retry status during execution
- Show attempt count in results

**Option B - Use Backend Defaults** (0 hours):
- No frontend changes needed
- Backend uses 10s timeout for all steps
- Backend retries 3 times for all steps
- Still works great!

**Recommendation**: Start with Option B (backend defaults), add UI later if users request it.

---

## ‚ö†Ô∏è Risk Assessment

### Low Risk ‚úÖ
- Retry logic isolated in wrapper method
- No database schema changes
- Backward compatible (existing tests work)
- TypeScript catches errors at compile time

### Medium Risk ‚ö†Ô∏è
- Retry delays increase test execution time
  - **Mitigation**: Configurable max attempts (default 3)
  - **Impact**: Test that fails 3x takes 7 seconds (1s + 2s + 4s delays)
- Smart waits might timeout on edge cases
  - **Mitigation**: Extensive testing with various scenarios

### Mitigation Strategy
1. Implement incrementally: Phase 1 ‚Üí test ‚Üí Phase 2 ‚Üí test ‚Üí etc.
2. Monitor test execution times in production
3. Make retry counts configurable if needed
4. Add metrics to track retry frequency

---

## üí¨ Questions for GEMINI Team Discussion

### 1. Frontend UI Priority
**Question**: Do you want to add retry/timeout UI controls now, or later?

**Options**:
- **A**: Add now (timeout + retry fields in step editor) - 2-3 hours
- **B**: Use backend defaults (10s timeout, 3 retries) - 0 hours, add UI later if needed

**Recommendation**: Option B - get backend working first, add UI based on user feedback.

---

### 2. Display Retry Information
**Question**: How should we show retry attempts to users?

**Options**:
- **A**: During execution: "Step 3/10: Click button (Attempt 2/3)"
- **B**: In results: "‚úÖ Passed on attempt 2"
- **C**: Both A and B
- **D**: No UI changes (just logs for debugging)

**Recommendation**: Option D now (logs), Option B later (results display).

---

### 3. Default Values
**Question**: Are these defaults reasonable?

- Max retry attempts: **3**
- Retry backoff: **1s ‚Üí 2s ‚Üí 4s**
- Default step timeout: **10 seconds**
- Wait polling interval: **500ms**

**Feedback Requested**: Too slow? Too fast? Just right?

---

### 4. Error Messages
**Question**: Should users see which retry attempt succeeded?

**Example**: "Step passed on attempt 2 (selector error recovered)"

**Options**:
- **Yes** - helpful for debugging
- **No** - too technical, just show final result

---

### 5. Scope for First Release
**Question**: Which phases should we implement first?

**Options**:
- **Minimal**: Phase 1 only (basic retry) - 1 hour
- **Standard**: Phases 1-2 (retry + smart waits) - 2 hours
- **Complete**: All 4 phases - 3 hours

**Recommendation**: Standard (Phases 1-2) - covers 80% of use cases.

---

## üöÄ Next Steps

### 1. Team Discussion (Now)
- GEMINI reviews this document
- GEMINI team discusses internally
- Answer the 5 questions above
- Decide on frontend involvement

### 2. Approval & Kickoff (After Discussion)
- Get consensus on approach
- Confirm frontend scope (UI or no UI)
- Claude begins Phase 1 implementation

### 3. Implementation (2-3 hours)
- Claude implements backend phases
- Test each phase before moving to next
- GEMINI can work on frontend in parallel (optional)

### 4. Integration & Testing (30 mins)
- Test end-to-end with real flaky scenarios
- Verify retry logic works as expected
- Check performance impact

### 5. Documentation & Completion
- Create session notes
- Update master plan
- Mark C2.2 as ‚úÖ COMPLETE

---

## üìù Code Examples Preview

### Before (Current Behavior)
```typescript
// Step fails once ‚Üí entire test fails
const result = await this.executeStep(page, step, execution);
if (!result.success) {
  throw new Error(result.error); // ‚ùå Test fails immediately
}
```

### After (With Retry)
```typescript
// Step retries 3 times before failing test
const result = await this.executeStepWithRetry(page, step, execution, 3);
// Returns: { success: true, attempts: 2 } ‚úÖ
// Or: { success: false, attempts: 3, error: "..." } ‚ùå
```

### Smart Wait Example
```typescript
// BEFORE: Hope element appears in time
await page.waitForTimeout(5000); // ü§û fingers crossed
const locator = page.locator(selector);

// AFTER: Poll until element appears
const found = await this.waitForElement(page, selector, 10000);
if (!found) throw new Error('Element never appeared');
const locator = page.locator(selector);
```

---

## üìö Reference Links

**Related Documents**:
- Master Plan: `/MASTER_PARALLEL_WORK_PLAN.md`
- Testing Guide: `/TESTING_GUIDE_C01_C02_C11.md`
- Hunt Elements Fix: `/notes/week-2025-12-22/2025-12-27_hunt-elements-500-fix.md`

**Key Files**:
- Execution Processor: `backend/src/queue/execution-queue.processor.ts`
- Retry Service (reference): `backend/src/analysis/analysis-retry.service.ts`
- Queue Config: `backend/src/queue/queue.module.ts`

---

## ‚ú® Summary

**What**: Add intelligent retry and wait logic to test step execution
**Why**: Make tests more reliable, handle slow loading, reduce false failures
**How**: 4 phases - retry foundation, smart waits, timeouts, error handling
**Effort**: 2.5-3 hours backend, 0-3 hours frontend (optional)
**Risk**: Low - isolated changes, backward compatible
**Impact**: 60-80% reduction in flaky test failures

**Ready for team discussion!** üöÄ

---

**Questions? Comments? Suggestions?**
Add them below or discuss in team chat.

**Approvers**:
- [ ] GEMINI Team Lead
- [ ] Claude (Backend)
- [ ] User (Product Owner)
